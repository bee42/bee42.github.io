<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Wir bauen einen kompletten Kubernetes-Cluster auf Embedded-Hardware."><title>Kubernetes Cluster on Embedded</title><link rel=icon href=/images/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/bootstrap.min.css><link href=/css/animate1.css rel=stylesheet><link href=/css/github-gist.css rel=stylesheet><link rel=stylesheet type=text/css href=/css/bicon.min.css><link rel=stylesheet type=text/css href=/css/owl.carousel.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href=https://bee42.com/sass/style.min.807b9d7ce089a7d39ca870a8727d83ec5a3cbfcaf75ae380e102836b0c36c229.css><link rel=stylesheet type=text/css href=/css/responsive-menu.css><link rel=stylesheet type=text/css href=/css/responsive.css></head><body class=sub-page><nav class=off-canvas><button class=close-btn><i class="fas fa-times"></i></button><ul><li class=menu-item><a href=/de/trainings>Trainings</a></li><li class=menu-item><a href=/de/consulting>Consulting</a></li><li class=menu-item><a href=/de/community>Community</a></li><li class=menu-item><a href=/de/about>Über Uns</a></li><li class=menu-item><a href=/de/jobs>Jobs</a></li><li class=menu-item><a href=/de/kontakt>Kontakt</a></li><li class=menu-item><a href=/de/blog>Blog</a></li><li class=menu-item><a href="https://twitter.com/bee42solutions?lang=%2fde" target=_blank><i class="fab fa-twitter"></i></a></li></ul></nav><div id=page><header class=site-header><div class=inner-header><a class=branding href=/index.html><img src=/images/bee42-logo.svg alt="bee42 Logo"></a>
<button class=open-btn><i class="fas fa-bars"></i></button><div class=off-canvas-btn><a id=mob-menu>☰</a>
<a id=mob-menu-close>×</a></div><nav class=site-navigation><ul id=menu-header-menu class=menu><li class=menu-item><a href=/de/trainings>Trainings</a></li><li class=menu-item><a href=/de/consulting>Consulting</a></li><li class=menu-item><a href=/de/community>Community</a></li><li class=menu-item><a href=/de/about>Über Uns</a></li><li class=menu-item><a href=/de/jobs>Jobs</a></li><li class=menu-item><a href=/de/kontakt>Kontakt</a></li><li class=menu-item><a href=/de/blog>Blog</a></li><li class=menu-item><a href="https://twitter.com/bee42solutions?lang=%2fde" target=_blank><i class="fab fa-twitter"></i></a></li></ul></nav></div><h1>Rethink IT</h1><h2>Wir verbessern Deine Systeme mit Begeisterung.</h2><a href=https://bee42.com/de/about class="button hero-button">Über die bee⁴²</a></header><div id=content><div class=blog-detail-wrapper><div class="col-lg-9 col-sm-8 col-md-8"><article class=post><h2>Kubernetes Cluster on Embedded</h2><div class=blog-content><p><h2 id=kubernetes-in-aller-munde>Kubernetes in aller Munde</h2><p>Viele Entwickler und Administatoren interssieren sich gerade für Kubernetes. In allen großen Clouds ist Kuberentes verfügbar. Allerdings ist die Cloud für kleine Geldbeutel auf die Dauer etwas teuer. Um einfach mal verschiedene Experimente mit Kubernetes zu wagen gibt es doch bestimmt günstigere Weg die Spaß machen.</p><h2 id=die-idee>Die Idee</h2><p>Wir bauen einen kompletten Kubernetes-Cluster auf Embedded-Hardware. Dazu benutzen wir einen EdgeRouterX, 2 WLAN-Router, 2 Switche, ein Intel UP-Board und für den eigentlichen K8S-Cluster Raspberry Pi&rsquo;s.</p><p>Schematisch soll es so aussehen:</p><p><img src=/images/blog/kubernetes_cluster_embedded/layout.png alt=Layout></p><p>Ein WLAN-Router stellt die Verbindung zum Internet her, den könnnt Ihr natürlich auch durch ein Kabel zu Eurem vorhanden Router ersetzen. Der EdgeRouterX ist für DHCP und DNS zuständig, und über den WLAN-Accesspoint können sich mehrere Leute mit der Umgebung verbinden. Dieses Setup benutzen wir gerne in Trainings und Workshops. Die verbleibende zentrale Komponente ist die Registry bzw. der Registry-Mirror auf dem Up-Board. Dieses hat eine Atom-CPU und ist um einiges performanter als die RPi&rsquo;s.</p><h2 id=unsere-hardware>Unsere Hardware</h2><p>Wir Ihr seht, ist also einiges an Hardware erforderlich. Die einzelnen Komponeten sind aber gar nicht sooo teuer :), bei vielen von Euch sind wahrscheinlich auch schon etliche Teile vorhanden.</p><p>Hier kurz die Liste der verwendeten Komponenten:</p><ul><li>2 x WLAN-Router (<a href=https://www.tp-link.com/us/products/details/cat-5506_TL-WR802N.html>https://www.tp-link.com/us/products/details/cat-5506_TL-WR802N.html</a>)</li></ul><div class=default-slider><img src=/images/blog/kubernetes_cluster_embedded/TL-WR802N.jpg alt=wlan-router></div><ul><li>EdgeRouterX (<a href=https://www.ubnt.com/edgemax/edgerouter-x/>https://www.ubnt.com/edgemax/edgerouter-x/</a>)</li></ul><div class=default-slider><img src=/images/blog/kubernetes_cluster_embedded/edgerouterx.jpeg alt=edge-router></div><ul><li>UP-Board (<a href=http://www.up-board.org/>http://www.up-board.org/</a>)</li></ul><div class=default-slider><img src=/images/blog/kubernetes_cluster_embedded/intel_up_board.png alt=up-board></div><ul><li>Und natürlich jede Menge Raspberry PI&rsquo;s&hellip;</li></ul><div class=default-slider><img src=/images/blog/kubernetes_cluster_embedded/RPI-Cluster.jpg alt=layout></div><p>Weitere Infos+Links für die verwendeten Bauteile findet Ihr in unserem <a href=https://github.com/bee42/kubernetes-on-embedded>Github-Repo</a></p><h2 id=der-ablauf>Der Ablauf</h2><p>Der eigentliche Ablauf, um Kubernetes auf die RPIs zu bringen, besteht aus wenigen Schritten:</p><ul><li>Flashen der SD-Cards mit einem passenden OS-Image mit Docker</li><li>Erstellen eines Verzeichnisses mit allen Rechnern, die in den Cluster sollen</li><li>Installation von Kubernetes. Dazu haben wir ein kleines Installationsscript geschrieben.</li></ul><h2 id=die-verwendete-software>Die verwendete Software</h2><ul><li><a href=https://github.com/hypriot/image-builder-rpi/>Hypriot OS</a> Die Hypriot-Piraten stellen regelmäßig aktualisierte Images bereit - Vielen Dank dafür!</li><li><a href=https://www.docker.com/community-edition>Docker</a> - ist bereits vorinstalliert auf dem Hypriot-Image</li><li><a href=https://kubernetes.io/>Kubernetes</a> - (kubeadm)</li><li><a href=https://docs.docker.com/registry/recipes/mirror/>Docker Registry-Mirror</a></li><li><a href=www.ansible.com>Ansible</a></li></ul><h2 id=vorbereitung-der-raspberry-pi-s>Vorbereitung der Raspberry PI&rsquo;s</h2><p>Wir benötigen für Kubernetes eine unterstützte Docker Version, in diesem Fall Docker CE 17.03. Das passende Image dazu hat die Versionsnummer v1.4.0. Wir haben natürlich auch andere Kombinationen ausprobiert, aber spätestens beim Installieren des Netzwerklayers kam es zu Inkompatibilitäten.</p><h3 id=flashen-des-os-images>Flashen des OS-Images</h3><p>Am einfachsten funktioniert das flashen mit dem <a href=https://github.com/hypriot/flash>Flash-Tool der Hyprioten</a> (Die Installation des Flash-Programme haben wir auf <a href=https://github.com/bee42/kubernetes-on-embedded>Github</a> näher beschrieben!)</p><pre><code class=language-bash>$ flash -n &quot;MY_HOSTNAME&quot; hypriotos-rpi-v${HOS_VERSION}.img
</code></pre><p><br></p><h3 id=raspberry-pi-s-starten>Raspberry-Pi&rsquo;s starten</h3><p>Nach dem Einsetzen der Karten könnt Ihr die Raspberry-PI starten. Nun könnt Ihr Euch zum Test mit dem PI per SSH verbinden.</p><pre><code class=language-bash>$ ssh pirate@&lt;ip&gt;
</code></pre><p>Das Passwort für den Nutzer <strong>pirate</strong> lautet: <strong>hypriot</strong>.</p><p><strong>Frage</strong>: Wie bekommt man eigentlich heraus welche IP dem PI vom DHCP Server zugeordnet wurde?</p><p>Wenn Ihr es nicht auf Eurem Router/DHCP-Server nachschauen könnt, geht das am einfachsten mit einem Netzwerk-Scan:</p><pre><code># install nmap
$ brew install nmap
$ nmap -sn 192.168.1.0/24 # Durch Euer Netz ersetzen
</code></pre><p><br></p><h2 id=kubernetes-cluster-installieren>Kubernetes-Cluster installieren</h2><h3 id=vorbereitung>Vorbereitung</h3><p>Zur Ausführung unseres Installationsscripts auf den einzelen RPIs benutzen wir <a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html>Ansible</a>.</p><p>Wir brauchen zuerst ein Inhaltsverzeichnis, in dem die verwendeten IP-Adressen der zukünftigen Cluster-Nodes stehen. Wir haben mehrere Cluster, deshalb ist die Konfiguration etwas größer angelegt. Hier ein Auszug für Cluster-1:</p><p><strong>inventory.ini</strong></p><pre><code class=language-ini>[cluster-1-master]
192.168.1.11

[cluster-1-nodes]
192.168.1.12
192.168.1.13

[cluster-1:children]
cluster-1-master
cluster-1-nodes

[cluster-1:vars]
fqdn_master=&quot;bee42-crew-01-001.bee42&quot;
network_address_master=&quot;192.168.1.11&quot;

[master:children]
cluster-1-master

[nodes:children]
cluster-1-nodes
</code></pre><p><br>Ansible verbindet sich per SSH auf die zu verwaltenden Rechner, dort muss also Euer öffentlicher SSH-Key hinterlegt sein. Falls Ihr das noch nicht bereits erledigt habt, könnt Ihr das jetzt nachholen.</p><p>Hier ein kleines Beispiel:</p><pre><code class=language-bash># Schlüssel erzeugen
$ ssh-keygen -t ed25519 -C &quot;name@example.org&quot;

# Öffentlichen Schlüssel auf alle RPIs kopieren
$ ssh-copy-id pirate@192.168.1.11
$ ssh-copy-id pirate@192.168.1.12
...

# und testen:

$ ansible -u pirate --key=PATH_TO_MY_PRIVATE_KEY -m ping all
192.168.1.11 | success &gt;&gt; {
    &quot;changed&quot;: false, 
    &quot;ping&quot;: &quot;pong&quot;
}

192.168.1.12 | success &gt;&gt; {
    &quot;changed&quot;: false, 
    &quot;ping&quot;: &quot;pong&quot;
}
</code></pre><p><br></p><h3 id=cluster-erzeugen>Cluster erzeugen</h3><p>So, wenn alle Vorbereitungen abgeschlossen sind, kann der Kubernetes-Cluster erzeugt werden. Ein Raspberry PI pro Cluster wird zum Master, die restlichen PIs werden die Nodes.</p><pre><code class=language-bash>$ ansible-playbook -u pirate --key=PATH_TO_MY_PRIVATE_KEY -i cluster -l cluster-1 kubernetes.yml
</code></pre><p><br></p><p>Dadurch werden folgende Schritte ausgeführt:</p><ul><li>Die benötigte Pakete werden heruntergeladen und installiert.</li><li>Auf dem Master-Rechner wird per <code>kubeadm init</code> die Kubernetes-Installation gestartet</li><li>Der Weave-Netzwerk-Layer für Kubernetes wird installiert</li><li>Eine kleine Datei <code>kubeadm_join</code> wird erzeugt und heruntergeladen. Darin steht das Kommando, um einen weiteren Node zu dem Cluster hinzuzufügen</li><li>Auf allen Nodes wird danach das entsprechende Join-Kommando ausgeführt</li></ul><p><strong>Noch ein wichtiger Hinweis:</strong> In unserem Script wird die Verwendung eines lokalen Registry-Mirrors eingerichtet. Dadurch müssen die Container-Images nur einmal zentral heruntergeladen werden und nicht von jedem einzelnen RPi selbst. <strong>Das müsstet Ihr ggf. anpassen/auskommentieren.</strong></p><p>Im Ordner <code>secrets</code> findet Ihr danach die Config-Datei für Kubernetes, oder Ihr springt auf den Master-Rechner und könnt dort als Root (<code>sudo -i</code>) dann Euren Cluster per <code>kubectl</code> verwalten. Also z.B. alle Nodes anzeigen mit</p><pre><code>$ kubectl get nodes
</code></pre><p>Und so sieht übrigens alles fertig aufgebaut aus:</p><p><img src=/images/blog/kubernetes_cluster_embedded/gesamtueberblick.jpg alt=Layout><br>Wenn Ihr Euch das genauer ansehen wollt: Alle Dateien stehen auf <a href=https://github.com/bee42/kubernetes-on-embedded>Github</a> bereit.</p><p>Viel Spaß mit dem Aufbau und besucht uns auf einem unser <a href=https://bee42.com/de/trainings/kubernetes-devops-lab/>Kubernetes Lab</a> zum ausprobieren. Wir kommen auch gerne zu Euch mit einem InHouse-Training&hellip;</p><p><img src=/images/blog/kubernetes_cluster_embedded/raspberrypi-joins-kubernetes.png alt=KubernetesLoveRaspberryPI></p><p>Die bee42 Crew</p></p></div><div class=clearfix></div></article></div><div class="col-lg-3 col-sm-4 col-md-4"><div id=blog-archive-sidebar class=sidebar><div class="widget panel wpforms-widget"><div class="wpforms-container wpforms-container-full" id=wpforms-31107><form class="wpforms-validate wpforms-form"><div class=wpforms-head-container><div class=wpforms-title>Werde Teil unserer bee42 community</div><div class=wpforms-description>Erhalte alle 14 Tage die neusten Blogposts, Trend, Events und Highlights rund um Docker, Kubernetes & Co.!</div></div><div class=wpforms-field-container><div class="wpforms-field wpforms-field-email"><input type=email class=wpforms-field-large placeholder="E-Mail-Adresse eingeben"></div></div><div class=wpforms-submit-container><button type=submit name=wpforms[submit] class=wpforms-submit value=wpforms-submit data-alt-text=Subscribing...>Abonieren</button></div></form></div></div><div class="widget panel popular-posts panel-secondary"><h2 class=section-title>Popular Posts</h2><ul><li><i class="bi bi-blog"></i><a href=https://bee42.com/de/blog/tutorials/docker-hosts-mit-puppet-provisionieren-und-testen/>Docker-Hosts mit Puppet provisionieren und testen</a></li><li><i class="bi bi-blog"></i><a href=https://bee42.com/de/blog/tutorials/docker-microservice-basis-mit-apache-tomcat-implementieren/>Docker Microservice Basis mit Apache Tomcat implementieren</a></li><li><i class="bi bi-blog"></i><a href=https://bee42.com/de/blog/tutorials/docker-entschluesselt-netzwerk-teil-2/>Docker entschlüsselt: Netzwerk Teil 2</a></li></ul></div></div></div></div></div><div class=overlay></div><footer><div class="container clear"><a class=branding href=index.html><img src=/images/bee42-logo.svg alt="bee42 logo"></a><ul class=footer-social-menu><li><a href=mailto:info@bee42.com><i class="fas fa-envelope"></i></a></li><li><a href=https://www.youtube.com/channel/UCQZcFFlmKBBAhvSupNTm2tw><i class="fab fa-youtube"></i></a></li><li><a href="https://twitter.com/bee42solutions?lang=%2fde"><i class="fab fa-twitter"></i></a></li></ul><div class="row footer-info"><ul class=meta-navigation><li><a href=/de/impressum>Impressum</a></li><li><a href=/de/datenschutz>Datenschutz</a></li><li><a href=/de/allgemeine-geschaeftsbedingungen>AGB</a></li><li><a href=/de/kontakt>Kontakt</a></li></ul><form class=newsletter method=post><h3>Newsletter abonnieren</h3><input class=email type=email placeholder="Deine E-Mail Adresse">
<button class=send>Senden</button></form><div class="row address"><a href=/de/locations/bochum><i class="fas fa-map-marker-alt"></i></a><ul class=location><li><strong>bee42 solutions gmbh</strong></li><li>Office: @Funkhaus Bochum</li><li>Kortumstraße 68</li><li>D-44787 Bochum</li></ul></div></div></div><div class=copyright><div class=container><p>© 2018 bee42 solutions gmbh. Alle Rechte vorbehalten</p></div></div></footer></div><div id=menu-sld class=mbmnu><div class=mobmenu-inner><ul id=menu-header-menu1 class=menu><li class=menu-item><a href=/de/trainings>Trainings</a></li><li class=menu-item><a href=/de/consulting>Consulting</a></li><li class=menu-item><a href=/de/community>Community</a></li><li class=menu-item><a href=/de/about>Über Uns</a></li><li class=menu-item><a href=/de/jobs>Jobs</a></li><li class=menu-item><a href=/de/kontakt>Kontakt</a></li><li class=menu-item><a href=/de/blog>Blog</a></li><li class=menu-item><a href="https://twitter.com/bee42solutions?lang=%2fde" target=_blank><i class="fab fa-twitter"></i></a></li></ul></div></div></div><div class=cookies-info id=cookies-container><p>"Um unsere Webseite für Sie optimal zu gestalten und fortlaufend verbessern zu können, verwenden wir Cookies. Durch die weitere Nutzung der Webseite stimmen Sie der Verwendung von Cookies zu. Weitere Informationen zu Cookies erhalten Sie in unserer <a href>Datenschutzerklärung</a>."</p><button id=cn-accept-cookie onclick="SetCookie('cookie_notice','0','7')">Ok</button></div><script>function SetCookie(c_name,value,expiredays){var exdate=new Date();exdate.setDate(exdate.getDate()+expiredays);document.cookie=c_name+"="+escape(value)+
((expiredays==null)?"":";expires="+exdate.toGMTString());document.getElementById("cookies-container").style.display="none";}
if(document.cookie){document.getElementById("cookies-container").style.display="none";}</script><script src=/js/jquery.js></script><script src=/js/bootstrap.min3.2.js></script><script src=/js/owl.carousel.min.js></script><script src=/js/highlight.pack.js></script><script src=/js/js-functions.js></script></body></html>